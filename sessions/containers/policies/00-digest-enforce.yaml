apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: digest-enforce.policy.example.com
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
  variables:
    - name: images
      expression: "(has(object.spec.containers) ? object.spec.containers.map(c, c.image) : []) + (has(object.spec.initContainers) ? object.spec.initContainers.map(c, c.image) : []) + (has(object.spec.ephemeralContainers) ? object.spec.ephemeralContainers.map(c, c.image) : [])"
  validations:
    - expression: "variables.images.all(img, img.matches('^.+@sha256:[0-9a-fA-F]{64}$'))"
      message: "All container images must use immutable SHA256 digests (no tags)."
      reason: Invalid
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: digest-enforce-binding
spec:
  policyName: digest-enforce.policy.example.com
  validationActions: ["Deny"]
